\setcounter{figure}{0}
\setcounter{table}{0}
\renewcommand{\thefigure}{S\arabic{figure}}
\renewcommand{\thetable}{S\Roman{table}}

\section*{Supplemental Material}

\begin{figure*}[h]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/cross-validation-for-simulated-populations.png}
  \caption{
  Time-series cross-validation scheme for simulated populations.
  Models were trained in six-year sliding windows (grey lines) and validated on out-of-sample data from validation timepoints (filled circles).
  Validation results from 30 years of data were used to iteratively tune model hyperparameters.
  After fixing hyperparameters, model coefficients were fixed at the mean values across all training windows.
  Fixed coefficients were applied to 10 years of new out-of-sample test data (open circles) to estimate true forecast errors.
  }
  \label{sup_fig:cross_validation_for_simulated_populations}
  \end{center}
\end{figure*}

\begin{figure*}[h]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/simulated-h3n2-ha-phylogeny.png}
  \caption{
  Phylogeny of A/H3N2-like HA sequences sampled between the 24th and 30th years of simulated evolution.
  The phylogenetic structure and rate of accumulated epitope and non-epitope mutations match patterns observed in phylogenies of natural sequences.
  Sample dates were annotated as the generation in the simulation divided by 200 and added to 2000, to acquire realistic date ranges that were compatible with our modeling machinery.
  }
  \label{sup_fig:simulated_h3n2_ha_phylogeny}
  \end{center}
\end{figure*}

\begin{table*}[ht]
  \begin{center}
    \input{tables/mutations_by_trunk_status_for_simulated_populations.tex}
    \caption{
    Number of epitope and non-epitope mutations per branch by trunk or side branch status for simulated populations.
    Epitope sites were defined previously described \cite{Luksza:2014hj}.
    Annotation of trunk and side branch was performed as previously described \cite{Bedford:2015fj}.
    Mutations were calculated for the full validation tree for simulated sequences samples between October of years 10 and 40.
    }
    \label{sup_table:mutations_by_trunk_status_for_simulated_populations}
  \end{center}
\end{table*}

\begin{table*}[ht]
  \begin{center}
    \input{tables/mutations_by_trunk_status.tex}
    \caption{
    Number of epitope and non-epitope mutations per branch by trunk or side branch status for natural populations.
    Epitope sites were defined previously described \cite{Luksza:2014hj}.
    Annotation of trunk and side branch was performed as previously described \cite{Bedford:2015fj}.
    Mutations were calculated for the full validation tree for natural sequences samples between 1990 and 2015.
    }
    \label{sup_table:mutations_by_trunk_status}
  \end{center}
\end{table*}

\begin{figure*}[t]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/unadjusted-composite-model-accuracy-and-coefficients-for-simulated-populations.png}
  \caption{
  Composite model coefficients and distances to the future for models fit to simulated populations.
  A) Coefficients and B) distances are shown per validation timepoint and test timepoint as in Fig.~\ref{fig:unadjusted_model_accuracy_and_coefficients_for_simulated_populations_controls}.
  }
  \label{sup_fig:unadjusted_composite_model_accuracy_and_coefficients_for_simulated_populations}
  \end{center}
\end{figure*}

\begin{figure*}[t]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/validation-of-best-model-for-simulated-populations.png}
  \caption{
  Validation of best model for simulated populations of A/H3N2-like viruses.
  A) The correlation of estimated and observed clade growth rates shows the model's ability to capture clade-level dynamics without explicitly optimizing for clade frequency targets.
  B) The rank of the estimated best strain based on its distance to the future for 33 timepoints.
  The estimated best strain was in the top 20th percentile of observed closest strains for 100\% of timepoints, confirming that the model makes a good choice when forced to select a single representative strain for the future population.
  C) Absolute forecast error for clades shown in A by their initial frequency with a mean LOESS fit (solid black line) and 95\% confidence intervals (grey shading) based on 100 bootstraps.
  D) The correlation of all strains at all timepoints by the percentile rank of their observed and estimated distances to the future.
  }
  \label{sup_fig:validation_of_best_model_for_simulated_populations}
  \end{center}
\end{figure*}

\begin{figure*}[h]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/cross-validation-for-natural-populations.png}
  \caption{
  Time-series cross-validation scheme for natural populations.
  Models were trained in six-year sliding windows (grey lines) and validated on out-of-sample data from validation timepoints (filled circles).
  Validation results from 25 years of data were used to iteratively tune model hyperparameters.
  After fixing hyperparameters, model coefficients were fixed at the mean values across all training windows.
  Fixed coefficients were applied to four years of new out-of-sample test data (open circles) to estimate true forecast errors.
  }
  \label{sup_fig:cross_validation_for_natural_populations}
  \end{center}
\end{figure*}

\begin{table*}[ht]
  \begin{center}
    \scalebox{0.9}{
        \input{tables/complete_natural_model_selection.tex}
    }
    \caption{
      All model coefficients and performance on validation and test data for natural populations ordered from best to worst by distance to the future, as in Table~\ref{table_simulated_model_selection}.
      Validation results are based on 23 timepoints.
      Test results are based on 8 timepoints not observed during model training and validation.
      Model results for additional variants of fitness metrics including those based on epitope mutations and DMS preferences are included for reference.
    }
    \label{sup_table:complete_natural_model_selection}
  \end{center}
\end{table*}

\begin{figure*}[h]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/unadjusted-composite-model-accuracy-and-coefficients-for-natural-populations-epitope-vs-oracle.png}
  \caption{
  Model coefficients and distances to the future for cross-immunity models fit to natural populations.
  A) Coefficients and B) distances are shown per validation timepoint and test timepoint as in Fig.~\ref{fig:unadjusted_model_accuracy_and_coefficients_for_simulated_populations_controls}.
  The epitope cross-immunity model relies on previously published epitope sites \cite{Luksza:2014hj}.
  The ``oracle'' cross-immunity model relies on sites of beneficial mutations that were manually identified from the entire training and validation time period (Methods).
  The improved performance of the ``oracle'' model indicates that the sequence-based cross-immunity metric can be effective when sites of beneficial mutations are known prior to forecasting.
  }
  \label{sup_fig:unadjusted_composite_model_accuracy_and_coefficients_for_natural_populations_epitope_vs_oracle}
  \end{center}
\end{figure*}

\begin{figure*}[ht]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/validation-of-best-model-for-natural-populations.png}
  \caption{
  Validation of best model for natural populations of A/H3N2 viruses, the composite model of mutational load and LBI.
  A) The correlation of estimated and observed clade growth rates shows the model's ability to capture clade-level dynamics without explicitly optimizing for clade frequency targets.
  B) The rank of the estimated best strain based on its distance to the future for 23 timepoints.
  The estimated best strain was in the top 20th percentile of observed closest strains for 87\% of timepoints, confirming that the model makes a good choice when forced to select a single representative strain for the future population.
  C) Absolute forecast error for clades shown in A by their initial frequency with a mean LOESS fit (solid black line) and 95\% confidence intervals (grey shading) based on 100 bootstraps.
  D) The correlation of all strains at all timepoints by the percentile rank of their observed and estimated distances to the future.
  }
  \label{sup_fig:validation_of_best_model_for_natural_populations}
  \end{center}
\end{figure*}

\begin{figure*}[ht]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/models-natural-populations-composite-with-updated-coefficients-across-test-data.png}
  \caption{
    Model coefficients and distances to the future for best composite models fit to recent data from natural populations as in Fig.~\ref{fig:unadjusted_model_accuracy_and_coefficients_for_simulated_populations_controls}.
    A) Coefficients and B) distances are shown per test timepoint (N=8).
    In contrast to the results for these models based on fixed coefficients from training/validation, these coefficients were learned for each six-year window prior to the corresponding test timepoint.
    The corresponding distances reflect the model's performance with updated coefficients on what is effectively new validation data.
    The naive model's distance to the future was 6.82 $\pm$ 1.74 AAs for these timepoints.
  }
  \label{sup_fig:updated_model_accuracy_and_coefficients_for_natural_populations_across_test_data}
  \end{center}
\end{figure*}
