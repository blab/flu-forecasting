\setcounter{figure}{0}
\setcounter{table}{0}
\renewcommand{\thefigure}{S\arabic{figure}}
\renewcommand{\thetable}{S\Roman{table}}

\section*{Supplemental Material}

\begin{figure*}[h]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/cross-validation-for-simulated-populations.png}
  \caption{
  Time-series cross-validation scheme for simulated populations.
  Models were trained in six-year sliding windows (grey lines) and validated on out-of-sample data from validation timepoints (filled circles).
  Validation results from 30 years of data were used to iteratively tune model hyperparameters.
  After fixing hyperparameters, model coefficients were fixed at the mean values across all training windows.
  Fixed coefficients were applied to 10 years of new out-of-sample test data (open circles) to estimate true forecast errors.
  }
  \label{sup_fig:cross_validation_for_simulated_populations}
  \end{center}
\end{figure*}

\begin{figure*}[h]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/simulated-h3n2-ha-phylogeny.png}
  \caption{
  Phylogeny of A/H3N2-like HA sequences sampled between the 24th and 30th years of simulated evolution.
  The phylogenetic structure and rate of accumulated epitope and non-epitope mutations match patterns observed in phylogenies of natural sequences.
  Sample dates were annotated as the generation in the simulation divided by 200 and added to 2000, to acquire realistic date ranges that were compatible with our modeling machinery.
  }
  \label{sup_fig:simulated_h3n2_ha_phylogeny}
  \end{center}
\end{figure*}

\begin{table*}[ht]
  \begin{center}
    \input{tables/mutations_by_trunk_status_for_simulated_populations.tex}
    \caption{
    Number of epitope and non-epitope mutations per branch by trunk or side branch status for simulated populations.
    Epitope sites were defined previously described \cite{Luksza:2014hj}.
    Annotation of trunk and side branch was performed as previously described \cite{Bedford:2015fj}.
    Mutations were calculated for the full validation tree for simulated sequences samples between October of years 10 and 40.
    }
    \label{sup_table:mutations_by_trunk_status_for_simulated_populations}
  \end{center}
\end{table*}

\begin{table*}[ht]
  \begin{center}
    \input{tables/mutations_by_trunk_status.tex}
    \caption{
    Number of epitope and non-epitope mutations per branch by trunk or side branch status for natural populations.
    Epitope sites were defined previously described \cite{Luksza:2014hj}.
    Annotation of trunk and side branch was performed as previously described \cite{Bedford:2015fj}.
    Mutations were calculated for the full validation tree for natural sequences samples between 1990 and 2015.
    }
    \label{sup_table:mutations_by_trunk_status}
  \end{center}
\end{table*}

\begin{figure*}[t]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/unadjusted-composite-model-accuracy-and-coefficients-for-simulated-populations.png}
  \caption{
  Composite model a) coefficients and b) distances to the future for models fit to simulated populations.
  Coefficients and distances are shown per validation timepoint and test timepoint as in Fig.~\ref{fig:unadjusted_model_accuracy_and_coefficients_for_simulated_populations_controls}.
  }
  \label{sup_fig:unadjusted_composite_model_accuracy_and_coefficients_for_simulated_populations}
  \end{center}
\end{figure*}

\begin{figure*}[t]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/validation-of-best-model-for-simulated-populations.png}
  \caption{
  Validation of best model for simulated populations of A/H3N2-like viruses.
  a) The correlation of estimated and observed clade growth rates shows the model's ability to capture clade-level dynamics without explicitly optimizing for clade frequency targets.
  b) The percentile rank in observed distance to the future of the model's estimated best strain for 33 validation timepoints.
  The estimated best strain is in the top 20th percentile of observed closest strains for 97\% of timepoints.
  }
  \label{sup_fig:validation_of_best_model_for_simulated_populations}
  \end{center}
\end{figure*}

\begin{table*}[ht]
  \begin{center}
    \input{tables/simulated_model_test.tex}
    \caption{
      Model coefficients and test performance for simulated populations ordered from best to worst by distance to the future.
      Coefficients shown here are the mean values across all training and validation windows which were used to test models on out-of-sample data.
      Distance to the future, approximation of future diversity, and number of times model outperforms the naive model are as in Table~\ref{table_simulated_model_selection} for all test timepoints (N=18).
    }
    \label{table_simulated_model_test}
  \end{center}
\end{table*}

\begin{figure*}[h]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/cross-validation-for-natural-populations.png}
  \caption{
  Time-series cross-validation scheme for natural populations.
  Models were trained in six-year sliding windows (grey lines) and validated on out-of-sample data from validation timepoints (filled circles).
  Validation results from 25 years of data were used to iteratively tune model hyperparameters.
  After fixing hyperparameters, model coefficients were fixed at the mean values across all training windows.
  Fixed coefficients were applied to four years of new out-of-sample test data (open circles) to estimate true forecast errors.
  }
  \label{sup_fig:cross_validation_for_natural_populations}
  \end{center}
\end{figure*}

\begin{table*}[ht]
  \begin{center}
    \input{tables/complete_natural_model_selection.tex}
    \caption{
      All model coefficients and validation performance for natural populations ordered from best to worst by distance to the future, as in Table~\ref{table_simulated_model_selection}.
      Results are based on training and validation across 23 training windows.
      Model results for additional variants of fitness metrics including those based on epitope mutations and DMS preferences are included for reference.
    }
    \label{sup_table:complete_natural_model_selection}
  \end{center}
\end{table*}

\begin{figure*}[h]
  \begin{center}
  \includegraphics[width=\textwidth]{figures/unadjusted-composite-model-accuracy-and-coefficients-for-natural-populations-epitope-vs-oracle.png}
  \caption{
  Model a) coefficients and b) distances to the future for cross-immunity models fit to natural populations.
  The epitope cross-immunity model relies on previously published epitope sites \cite{Luksza:2014hj}.
  The ``oracle'' cross-immunity model relies on sites of beneficial mutations that were manually identified from the entire training and validation time period.
  The improved performance of the ``oracle'' model indicates that the cross-immunity can be effective when sites of beneficial mutations are known prior to forecasting.
  Coefficients and distances are shown per validation timepoint and test timepoint as in Fig.~\ref{fig:unadjusted_model_accuracy_and_coefficients_for_simulated_populations_controls}.
  }
  \label{sup_fig:unadjusted_composite_model_accuracy_and_coefficients_for_natural_populations_epitope_vs_oracle}
  \end{center}
\end{figure*}

\begin{table*}[ht]
  \begin{center}
    \input{tables/complete_natural_model_test.tex}
    \caption{
      All model coefficients and test performance for natural populations ordered from best to worst by distance to the future, as in Supplemental Table~\ref{table_simulated_model_test}.
      Results are based on 8 test timepoints.
    }
    \label{sup_table:complete_natural_model_test}
  \end{center}
\end{table*}
